treat_pval = ASTres_pval,
# min_pval = 0.01,
groups_labeled = c("top_center", "bottom_center", "middle_right", "middle_left", "bottom_left"),
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTres LFC",
title = "RRA_byrep: UT vs ASTres",
goi = c("Ufd1", "Vcp", "Nploc4", "Rigi", "Rnf125", "Ddx58", "Isg15"))
install()
?assign
stringr::str_replace(c("RRA_dz", "rra_dz", "rRa_dz", "alchemy_dzenting"), "(?<=(rra|RRA))_dz", "")
document()
document()
check()
test_data <- readRDS("data/test_data.RDS")
check()
document()
check()
test_data <- readRDS("D:/Bibliotecas/Biologia/Experimentos/ALISERTIB_screen/Analysis/test_data.RDS")
rm(test_data)
test_data <- readRDS("D:/Bibliotecas/Biologia/Experimentos/ALISERTIB_screen/Analysis/test_data.RDS")
check()
document()
?purrr::set_names
check()
check()
install()
install()
usethis::use_r(NineSquares_postprocess)
usethis::use_r("NineSquares_postprocess")
usethis::use_r("ImportDrugZ")
DrugZ_dir <- "D:/Bibliotecas/Biologia/Experimentos/ALISERTIB_screen/Analysis/drugz_allrep"
drugz_allrep_summs <- ImportDrugZ(DrugZ_dir = DrugZ_dir, extra_prefix = "allreps")
load_all()
drugz_allrep_summs <- ImportDrugZ(DrugZ_dir = DrugZ_dir, extra_prefix = "allreps")
load_all()
drugz_allrep_summs <- ImportDrugZ(DrugZ_dir = DrugZ_dir, extra_prefix = "allreps")
DrugZ_dir <- "D:/Bibliotecas/Biologia/Experimentos/ALISERTIB_screen/Analysis/drugz_allrep/"
load_all()
drugz_allrep_summs <- ImportDrugZ(DrugZ_dir = DrugZ_dir, extra_prefix = "allreps")
drugz_comparisons <- list.files(DrugZ_dir) %>% stringr::str_replace_all("-", "_")
list.files(DrugZ_dir)
DrugZ_dir <- "D:/Bibliotecas/Biologia/Experimentos/ALISERTIB_screen/Analysis/drugz_allreps"
load_all()
drugz_allrep_summs <- ImportDrugZ(DrugZ_dir = DrugZ_dir, extra_prefix = "allreps")
View(drugz_allrep_summs)
drugz_allrep_summs <- ImportDrugZ(DrugZ_dir = DrugZ_dir)
BuildDrugZdz <- function(drugz_list, pattern = "^([dD]|[dD])ay0_", order = NULL) {
if(!is.null(pattern)) {
matching_names <- stringr::str_subset(names(drugz_list), pattern = pattern)
summ_list <- drugz_list[matching_names]
# Use the pattern to extract prefixes by removing it from names
prefixes <- stringr::str_replace_all(names(summ_list), pattern, "")
} else {
summ_list <- drugz_list
# If no pattern, use full names as prefixes
prefixes <- names(summ_list)
}
if (length(summ_list) == 0) {
stop(paste0("No DrugZ objects found matching pattern ", pattern))
}
# Generate a list of built dataframes with minimum pvalue and fdr for each gene
df_list <-
purrr::map2(summ_list, prefixes, function(df, prefix) {
df %>%
as.data.frame() %>%
dplyr::rowwise() %>%
dplyr::mutate(min_pval = min(dplyr::c_across(dplyr::contains("p_val"))),
min_fdr = min(dplyr::c_across(dplyr::contains("fdr")))) %>%
dplyr::select(.data$GENE,
.data$numObs,
.data$normZ,
.data$min_pval,
.data$min_fdr) %>%
dplyr::rename_with(
.cols = 2:5,
.fn = ~ stringr::str_replace_all(., "min", prefix)
)
})
# Now we merge them all together by id and num
df_collapsed <- purrr::reduce(df_list, dplyr::full_join, by = c("id", "num")) %>% tidyr::drop_na()
# Reorder columns if order parameter is provided
if (!is.null(order)) {
if(is.factor(order)) {
order_levels <- levels(order)
}
else if(is.character(order)) {
order_levels <- order
}
else {
stop("order parameter must be a character vector or factor to order by.")
}
# Reorder columns
df_collapsed <-
df_collapsed %>%
dplyr::select(
.data$id,
.data$num,
!!!purrr::map(order_levels, ~ dplyr::starts_with(paste0(.x, "_")))
)
}
return(df_collapsed)
}
load_all()
BuildDrugZdz(drugz_allrep_summs)
load_all()
Drugz_dz_allreps <-
BuildDrugZdz(drugz_allrep_summs)
load_all()
BuildDrugZdz
load_all()
BuildDrugZdz
BuildDrugZdz <- function(drugz_list, pattern = "^([dD]|[dD])ay0_", order = NULL) {
if(!is.null(pattern)) {
matching_names <- stringr::str_subset(names(drugz_list), pattern = pattern)
summ_list <- drugz_list[matching_names]
# Use the pattern to extract prefixes by removing it from names
prefixes <- stringr::str_replace_all(names(summ_list), pattern, "")
} else {
summ_list <- drugz_list
# If no pattern, use full names as prefixes
prefixes <- names(summ_list)
}
if (length(summ_list) == 0) {
stop(paste0("No DrugZ objects found matching pattern ", pattern))
}
# Generate a list of built dataframes with minimum pvalue and fdr for each gene
df_list <-
purrr::map2(summ_list, prefixes, function(df, prefix) {
df %>%
as.data.frame() %>%
dplyr::rowwise() %>%
dplyr::mutate(min_pval = min(dplyr::c_across(dplyr::contains("pval"))),
min_fdr = min(dplyr::c_across(dplyr::contains("fdr")))) %>%
dplyr::select(.data$GENE,
.data$numObs,
.data$normZ,
.data$min_pval,
.data$min_fdr) %>%
dplyr::rename_with(
.cols = 2:5,
.fn = ~ stringr::str_replace_all(., "min", prefix)
)
})
# Now we merge them all together by id and num
df_collapsed <- purrr::reduce(df_list, dplyr::full_join, by = c("id", "num")) %>% tidyr::drop_na()
# Reorder columns if order parameter is provided
if (!is.null(order)) {
if(is.factor(order)) {
order_levels <- levels(order)
}
else if(is.character(order)) {
order_levels <- order
}
else {
stop("order parameter must be a character vector or factor to order by.")
}
# Reorder columns
df_collapsed <-
df_collapsed %>%
dplyr::select(
.data$id,
.data$num,
!!!purrr::map(order_levels, ~ dplyr::starts_with(paste0(.x, "_")))
)
}
return(df_collapsed)
}
Drugz_dz_allreps <-
BuildDrugZdz(drugz_allrep_summs)
load_all()
rm(BuildDrugZdz)
BuildDrugZdz
Drugz_dz_allreps <-
BuildDrugZdz(drugz_allrep_summs)
View(Drugz_dz_allreps)
?stringr::str_replace_all
load_all()
Drugz_dz_allreps <-
BuildDrugZdz(drugz_allrep_summs)
View(Drugz_dz_allreps)
install()
c("d0_test1", "D0_test2", "Day0_test3", "day0_test4", "5_test5") %>% str_detect("^([dD]|[dD])ay0_")
c("d0_test1", "D0_test2", "Day0_test3", "day0_test4", "5_test5") %>% stringr::str_detect("^([dD]|[dD])ay0_")
c("d0_test1", "D0_test2", "Day0_test3", "day0_test4", "5_test5") %>% stringr::str_detect("^([dD]|[dD]ay)0_")
document()
check()
document()
check()
install()
return(graph_list$data)
?dplyr::arrange
load_all()
DrugZ_dir <- "D:/Bibliotecas/Biologia/Experimentos/ALISERTIB_screen/Analysis/drugz_allreps"
drugz_allrep_summs <- ImportDrugZ(DrugZ_dir = DrugZ_dir)
Drugz_dz_allreps <-
BuildDrugZdz(drugz_allrep_summs)
Drugz_dz_allreps <-
BuildDrugZdz(drugz_allrep_summs)
test <-
NineSquares(drugz_dz_allrep,
control = UT_normZ,
treatment = ASTsen_normZ,
ctrl_pval = UT_pval,
treat_pval = ASTsen_pval,
min_pval = 0.01,
top_labeled = 10,
groups_labeled = c("bottom_left", "bottom_center", "bottom_right"),
xlab = "UT normZ",
ylab = "ASTsen normZ",
title = "DrugZ_allrep: UT vs ASTsen",
goi_auto = TRUE)
test <-
NineSquares(Drugz_dz_allreps,
control = UT_normZ,
treatment = ASTsen_normZ,
ctrl_pval = UT_pval,
treat_pval = ASTsen_pval,
min_pval = 0.01,
top_labeled = 10,
groups_labeled = c("bottom_left", "bottom_center", "bottom_right"),
xlab = "UT normZ",
ylab = "ASTsen normZ",
title = "DrugZ_allrep: UT vs ASTsen",
goi_auto = TRUE)
NSextractdata(test)
load_all()
NSextractdata(test)
load_all()
NSextractdata(test)
which = c(
"data",
"bottom_center",
"bottom_left",
"bottom_right",
"top_left",
"top_right",
"top_center",
"middle_right",
"middle_left",
"center",
"neutral_slope"
)
which == c(
"data",
"bottom_center",
"bottom_left",
"bottom_right",
"top_left",
"top_right",
"top_center",
"middle_right",
"middle_left",
"center",
"neutral_slope"
)
load_all()
NSextractdata(test)
rlang::last_trace()
load_all()
NSextractdata(test)
NSextractdata(test) %>% class()
load_all()
NSextractdata(test) %>% class()
load_all()
NSextractdata(test) %>% class()
NSextractdata(test)
load_all()
NSextractdata(test)
load_all()
NSextractdata(test)
NSextractdata(test, which = "bottomcenter")
NSextractdata(test, which = "bottom_center")
load_all()
NSextractdata(test, which = "bottom_center")
load_all()
NSextractdata(test, which = "bottom_center")
load_all()
NSextractdata(test, which = "bottom_center")
document()
check()
load_all()
install()
usethis::use_r("Postprocess_utils")
load_all()
document()
load_all()
install()
install()
# Create sample data to test current behavior
library(dplyr)
test_data <- data.frame(
id = c("GENE1", "GENE2", "GENE3", "GENE4"),
square = c("top_left", "top_right", "top_left", "bottom_center")
)
# Test with multiple genes
genes_to_find <- c("GENE1", "GENE3", "GENE2")
# Current output structure
result <- lapply(setNames(genes_to_find, genes_to_find), function(gene) {
test_data$square[test_data$id == gene]
})
print("Current output structure:")
print(result)
print(str(result))
# What you want: named list where each element has a vector matching input order
test_data_list <- list(
graphA = data.frame(
id = c("GENE1", "GENE2", "GENE3", "GENE4"),
square = c("top_left", "top_right", "top_left", "bottom_center")
),
graphB = data.frame(
id = c("GENE1", "GENE2", "GENE3", "GENE4"),
square = c("bottom_right", "center", "top_right", "neutral_slope")
)
)
genes_to_find <- c("GENE1", "GENE3", "GENE2")
# Desired output structure
desired <- list(
graphA = c("top_left", "top_left", "top_right"),  # Matches order: GENE1, GENE3, GENE2
graphB = c("bottom_right", "top_right", "center")  # Same order
)
print("Desired output:")
print(desired)
# Test the modified logic
source("D:/Bibliotecas/Biologia/crispyr/R/Postprocess_utils.R")
test_data_list <- list(
graphA = data.frame(
id = c("GENE1", "GENE2", "GENE3", "GENE4"),
square = c("top_left", "top_right", "top_left", "bottom_center")
),
graphB = data.frame(
id = c("GENE1", "GENE2", "GENE3", "GENE4"),
square = c("bottom_right", "center", "top_right", "neutral_slope")
)
)
genes_to_find <- c("GENE1", "GENE3", "GENE2")
# Test with list of dataframes
result <- where_is(genes_to_find, test_data_list)
print("Result with list of dataframes:")
print(result)
devtools::install()
??write_delim
?tryCatch()
document()
library(dplyr)
# Test data
test_data <- data.frame(
id = 1:5,
num = 3:7,
ctrl = rnorm(5),
treat = rnorm(5),
ctrl_p = runif(5),
treat_p = runif(5)
)
# Test function with missing argument
test_select <- function(data, ctrl_pval, treat_pval, ext_pval) {
data %>%
select(
id = 1,
num = 2,
ctrl_pval = {{ ctrl_pval }},
treat_pval = {{ treat_pval }},
ext_pval = {{ ext_pval }}
)
}
# Call without ext_pval
result <- test_select(test_data, ctrl_p, treat_p)
print(result)
# Let's verify with ext_pval provided
result_with_ext <- test_select(test_data, ctrl_p, treat_p, num)
print(result_with_ext)
document()
document()
document()
install()
install()
install()
check()
install()
# Test what happens with missing() and &&
test_fn <- function(x) {
# This is what the current code does:
result1 <- !missing(x) && print("evaluating x")
print(paste("Result with missing x:", result1))
# The issue: even with short-circuit, the condition structure
cat("\nTesting the actual condition logic:\n")
# Simulating: when x is missing
if (!missing(x)) {
cat("x is NOT missing\n")
} else {
cat("x IS missing\n")
}
}
test_fn()  # call without x
library(dplyr)
test_data <- data.frame(a = 1:3, b = 4:6)
test_pull <- function(data, col) {
# Try to pull with missing argument
dplyr::pull(data, {{ col }})
}
# Test with missing argument
tryCatch(
test_pull(test_data),
error = function(e) print(paste("Error:", e$message))
)
library(crispyr)
# Create test data
set.seed(42)
test_data <- data.frame(
gene = paste0("Gene", 1:100),
num = sample(3:10, 100, replace = TRUE),
UT_lfc = rnorm(100, mean = 0, sd = 2),
ASTsen_lfc = rnorm(100, mean = 0, sd = 2),
UT_pval = runif(100, min = 0, max = 1),
ASTsen_pval = runif(100, min = 0, max = 1)
)
# Test WITHOUT p-values (like your failing case)
result <- NineSquares(test_data,
control = UT_lfc,
treatment = ASTsen_lfc,
# ctrl_pval = UT_pval,      # commented out
# treat_pval = ASTsen_pval, # commented out
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTsen LFC",
title = "Test: UT vs ASTsen without pvals")
print("Success! Plot created without p-values")
# Reload package to get latest changes
devtools::load_all()
# Now test again
result <- NineSquares(test_data,
control = UT_lfc,
treatment = ASTsen_lfc,
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTsen LFC",
title = "Test: UT vs ASTsen without pvals")
print("Success!")
# Test missing() with tidy eval
library(dplyr)
test_fn <- function(data, col) {
cat("Is col missing?", missing(col), "\n")
if (!missing(col)) {
cat("About to pull...\n")
result <- dplyr::pull(data, {{ col }})
cat("Pull succeeded!\n")
return(result)
} else {
cat("col is missing, skipping pull\n")
}
}
test_data <- data.frame(a = 1:3, b = 4:6)
# Call without col
test_fn(test_data)
# Test argument forwarding with missing()
inner_fn <- function(data, col) {
cat("In inner_fn, is col missing?", missing(col), "\n")
if (!missing(col)) {
cat("About to pull in inner_fn...\n")
result <- dplyr::pull(data, {{ col }})
return(result)
} else {
cat("col is missing in inner_fn\n")
}
}
outer_fn <- function(data, col) {
cat("In outer_fn, is col missing?", missing(col), "\n")
inner_fn(data, {{ col }})
}
test_data <- data.frame(a = 1:3, b = 4:6)
# Call outer without col - does it forward the "missing" status?
outer_fn(test_data)
devtools::load_all()
# Test WITHOUT p-values
result <- NineSquares(test_data,
control = UT_lfc,
treatment = ASTsen_lfc,
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTsen LFC",
title = "Test: UT vs ASTsen without pvals")
print("Success! Plot created without p-values")
# Test WITHOUT p-values
result <- NineSquares(test_data,
control = "UT_lfc",
treatment = "ASTsen_lfc",
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTsen LFC",
title = "Test: UT vs ASTsen without pvals")
print("Success! Plot created without p-values")
names(test_data)
# Recreate test data
set.seed(42)
test_data <- data.frame(
gene = paste0("Gene", 1:100),
num = sample(3:10, 100, replace = TRUE),
UT_lfc = rnorm(100, mean = 0, sd = 2),
ASTsen_lfc = rnorm(100, mean = 0, sd = 2),
UT_pval = runif(100, min = 0, max = 1),
ASTsen_pval = runif(100, min = 0, max = 1)
)
# Test WITHOUT p-values (unquoted column names, as user would use)
result <- NineSquares(test_data,
control = UT_lfc,
treatment = ASTsen_lfc,
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTsen LFC",
title = "Test: UT vs ASTsen without pvals")
print("Success! Plot created without p-values")
install()
