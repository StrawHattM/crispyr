cat("Is col missing?", missing(col), "\n")
if (!missing(col)) {
cat("About to pull...\n")
result <- dplyr::pull(data, {{ col }})
cat("Pull succeeded!\n")
return(result)
} else {
cat("col is missing, skipping pull\n")
}
}
test_data <- data.frame(a = 1:3, b = 4:6)
# Call without col
test_fn(test_data)
# Test argument forwarding with missing()
inner_fn <- function(data, col) {
cat("In inner_fn, is col missing?", missing(col), "\n")
if (!missing(col)) {
cat("About to pull in inner_fn...\n")
result <- dplyr::pull(data, {{ col }})
return(result)
} else {
cat("col is missing in inner_fn\n")
}
}
outer_fn <- function(data, col) {
cat("In outer_fn, is col missing?", missing(col), "\n")
inner_fn(data, {{ col }})
}
test_data <- data.frame(a = 1:3, b = 4:6)
# Call outer without col - does it forward the "missing" status?
outer_fn(test_data)
devtools::load_all()
# Test WITHOUT p-values
result <- NineSquares(test_data,
control = UT_lfc,
treatment = ASTsen_lfc,
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTsen LFC",
title = "Test: UT vs ASTsen without pvals")
print("Success! Plot created without p-values")
# Test WITHOUT p-values
result <- NineSquares(test_data,
control = "UT_lfc",
treatment = "ASTsen_lfc",
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTsen LFC",
title = "Test: UT vs ASTsen without pvals")
print("Success! Plot created without p-values")
names(test_data)
# Recreate test data
set.seed(42)
test_data <- data.frame(
gene = paste0("Gene", 1:100),
num = sample(3:10, 100, replace = TRUE),
UT_lfc = rnorm(100, mean = 0, sd = 2),
ASTsen_lfc = rnorm(100, mean = 0, sd = 2),
UT_pval = runif(100, min = 0, max = 1),
ASTsen_pval = runif(100, min = 0, max = 1)
)
# Test WITHOUT p-values (unquoted column names, as user would use)
result <- NineSquares(test_data,
control = UT_lfc,
treatment = ASTsen_lfc,
top_labeled = 10,
xlab = "UT LFC",
ylab = "ASTsen LFC",
title = "Test: UT vs ASTsen without pvals")
print("Success! Plot created without p-values")
install()
# Load the package
library(devtools)
load_all("D:/Bibliotecas/Biologia/crispyr")
# Check if any data exists from devlog
if(file.exists("D:/Bibliotecas/Biologia/Experimentos/ALISERTIB_screen/Analysis/test_data.RDS")) {
cat("Test data file exists\n")
} else {
cat("No test data file found\n")
}
# Create test data simulating MLE output structure
set.seed(42)
mle_data <- data.frame(
Gene = paste0("Gene", 1:100),  # MLE uses "Gene" column
num = sample(3:10, 100, replace = TRUE),
control_beta = rnorm(100, mean = 0, sd = 1),
treatment_beta = rnorm(100, mean = 0, sd = 1),
control_pval = runif(100, 0, 1),
treatment_pval = runif(100, 0, 1)
)
# Create test data simulating RRA output structure
rra_data <- data.frame(
id = paste0("Gene", 1:100),  # RRA uses "id" column
num = sample(3:10, 100, replace = TRUE),
control_lfc = rnorm(100, mean = 0, sd = 1),
treatment_lfc = rnorm(100, mean = 0, sd = 1),
control_pval = runif(100, 0, 1),
treatment_pval = runif(100, 0, 1)
)
# Create NineSquares graphs from both
mle_graph <- NineSquares(
mle_data,
control_beta,
treatment_beta,
control_pval,
treatment_pval,
min_sgrna = 3,
scale = 1.5,
top_labeled = 3,
title = "MLE Test"
)
rra_graph <- NineSquares(
rra_data,
control_lfc,
treatment_lfc,
control_pval,
treatment_pval,
min_sgrna = 3,
scale = 1.5,
top_labeled = 3,
title = "RRA Test"
)
# Check the structure of the data in each graph
cat("MLE graph data columns:\n")
cat(paste(colnames(mle_graph$data), collapse = ", "), "\n\n")
cat("RRA graph data columns:\n")
cat(paste(colnames(rra_graph$data), collapse = ", "), "\n\n")
# Test where_is on both
test_genes <- c("Gene1", "Gene10", "Gene50")
cat("Testing where_is on MLE graph:\n")
mle_result <- where_is(test_genes, mle_graph)
print(mle_result)
cat("\nTesting where_is on RRA graph:\n")
rra_result <- where_is(test_genes, rra_graph)
print(rra_result)
# Test where_is on the raw MLE data structure (with "Gene" column)
cat("Structure of mle_data (raw):\n")
str(mle_data)
cat("\n\nTrying where_is on raw mle_data (should fail):\n")
try({
result <- where_is(c("Gene1", "Gene10"), mle_data)
print(result)
}, silent = FALSE)
cat("\n\nStructure of rra_data (raw):\n")
str(rra_data)
cat("\n\nTrying where_is on raw rra_data (should work if it has id and square columns):\n")
try({
result <- where_is(c("Gene1", "Gene10"), rra_data)
print(result)
}, silent = FALSE)
# Let's check what happens if we extract the data from the graphs first
cat("\n\n=== Testing extractNSdata ===\n")
mle_extracted <- extractNSdata(mle_graph)
rra_extracted <- extractNSdata(rra_graph)
cat("Columns in MLE extracted data:\n")
print(names(mle_extracted))
cat("\nColumns in RRA extracted data:\n")
print(names(rra_extracted))
cat("\nTesting where_is on extracted MLE data:\n")
result_mle <- where_is(c("Gene1", "Gene10"), mle_extracted)
print(result_mle)
cat("\nTesting where_is on extracted RRA data:\n")
result_rra <- where_is(c("Gene1", "Gene10"), rra_extracted)
print(result_rra)
# Simulate what happens when you import MLE and RRA data and create graphs
mle_list <- list(
comp1 = mle_graph,
comp2 = mle_graph
)
rra_list <- list(
comp1 = rra_graph,
comp2 = rra_graph
)
cat("Testing where_is on list of MLE graphs:\n")
result_mle_list <- where_is(c("Gene1", "Gene10"), mle_list)
print(result_mle_list)
cat("\n\nTesting where_is on list of RRA graphs:\n")
result_rra_list <- where_is(c("Gene1", "Gene10"), rra_list)
print(result_rra_list)
cat("\n\n=== The REAL issue test ===\n")
cat("If someone uses where_is on raw imported MLE data (not graphs):\n")
# Simulate imported MLE data (list of dataframes with Gene column, NO square column)
mle_raw_list <- list(
comp1 = mle_data,  # has "Gene" column, not "id", no "square" column
comp2 = mle_data
)
# Simulate imported RRA data (list of dataframes with id column, NO square column)
rra_raw_list <- list(
comp1 = rra_data,  # has "id" column, no "square" column
comp2 = rra_data
)
cat("\nTesting where_is on raw MLE data list (BROKEN):\n")
result_raw_mle <- where_is(c("Gene1", "Gene10"), mle_raw_list)
print(result_raw_mle)
cat("\nTesting where_is on raw RRA data list (ALSO BROKEN but differently):\n")
result_raw_rra <- where_is(c("Gene1", "Gene10"), rra_raw_list)
print(result_raw_rra)
# Test individual graphs first
cat("=== Testing INDIVIDUAL graphs ===\n")
cat("\nMLE individual graph:\n")
result_mle_single <- where_is(c("Gene1", "Gene10"), mle_graph)
print(result_mle_single)
cat("\nRRA individual graph:\n")
result_rra_single <- where_is(c("Gene1", "Gene10"), rra_graph)
print(result_rra_single)
# Now test lists of graphs
cat("\n\n=== Testing LISTS of graphs ===\n")
cat("\nMLE list of graphs:\n")
print(names(mle_list))
result_mle_list <- where_is(c("Gene1", "Gene10"), mle_list)
print(result_mle_list)
cat("\nRRA list of graphs:\n")
print(names(rra_list))
result_rra_list <- where_is(c("Gene1", "Gene10"), rra_list)
print(result_rra_list)
# Check the structure difference
cat("\n\n=== Checking graph list structure ===\n")
cat("MLE list class:", class(mle_list), "\n")
cat("RRA list class:", class(rra_list), "\n")
cat("MLE list[[1]] class:", class(mle_list[[1]]), "\n")
cat("RRA list[[1]] class:", class(rra_list[[1]]), "\n")
# Check if they are ggplot objects
cat("\nMLE list[[1]] is gg?", inherits(mle_list[[1]], "gg"), "\n")
cat("RRA list[[1]] is gg?", inherits(rra_list[[1]], "gg"), "\n")
# Let me check what happens when we create graphs from ImportMLE vs ImportRRA structure
# The key difference is the first column name
# Create data with MLE structure (Gene column)
set.seed(123)
mle_import_sim <- data.frame(
Gene = paste0("Gene", 1:50),
num = sample(3:10, 50, replace = TRUE),
cond1_beta = rnorm(50),
cond2_beta = rnorm(50),
cond1_pval = runif(50),
cond2_pval = runif(50)
)
# Create data with RRA structure (id column)
rra_import_sim <- data.frame(
id = paste0("Gene", 1:50),
num = sample(3:10, 50, replace = TRUE),
cond1_lfc = rnorm(50),
cond2_lfc = rnorm(50),
cond1_pval = runif(50),
cond2_pval = runif(50)
)
cat("MLE structure (first column):", names(mle_import_sim)[1], "\n")
cat("RRA structure (first column):", names(rra_import_sim)[1], "\n\n")
# Create graphs from both
mle_g1 <- NineSquares(mle_import_sim, cond1_beta, cond2_beta,
cond1_pval, cond2_pval, scale = 1, top_labeled = 2)
rra_g1 <- NineSquares(rra_import_sim, cond1_lfc, cond2_lfc,
cond1_pval, cond2_pval, scale = 1, top_labeled = 2)
# Put in lists
mle_glist <- list(comp1 = mle_g1, comp2 = mle_g1)
rra_glist <- list(comp1 = rra_g1, comp2 = rra_g1)
cat("Testing where_is on MLE graph list:\n")
mle_test <- where_is(c("Gene1", "Gene5"), mle_glist)
print(mle_test)
cat("\nTesting where_is on RRA graph list:\n")
rra_test <- where_is(c("Gene1", "Gene5"), rra_glist)
print(rra_test)
# Check the data structure in the graphs
cat("\n\nColumn names in MLE graph data:\n")
print(names(mle_g1$data))
cat("\nColumn names in RRA graph data:\n")
print(names(rra_g1$data))
# Let me check your actual workspace variables more carefully
cat("Checking your existing variables:\n\n")
# Check mle_list structure
cat("mle_list structure:\n")
cat("Class:", class(mle_list), "\n")
cat("Length:", length(mle_list), "\n")
cat("Names:", paste(names(mle_list), collapse=", "), "\n")
if(length(mle_list) > 0) {
cat("First element class:", class(mle_list[[1]]), "\n")
cat("Is first element a gg object?", inherits(mle_list[[1]], "gg"), "\n")
if(inherits(mle_list[[1]], "gg")) {
cat("First element data columns:", paste(names(mle_list[[1]]$data), collapse=", "), "\n")
cat("Has square column?", "square" %in% names(mle_list[[1]]$data), "\n")
}
}
cat("\n\nrra_list structure:\n")
cat("Class:", class(rra_list), "\n")
cat("Length:", length(rra_list), "\n")
cat("Names:", paste(names(rra_list), collapse=", "), "\n")
if(length(rra_list) > 0) {
cat("First element class:", class(rra_list[[1]]), "\n")
cat("Is first element a gg object?", inherits(rra_list[[1]], "gg"), "\n")
if(inherits(rra_list[[1]], "gg")) {
cat("First element data columns:", paste(names(rra_list[[1]]$data), collapse=", "), "\n")
cat("Has square column?", "square" %in% names(rra_list[[1]]$data), "\n")
}
}
# Now test where_is on them
cat("\n\n=== Testing where_is ===\n")
cat("Testing on mle_list:\n")
test_result_mle <- where_is("Gene1", mle_list)
print(test_result_mle)
cat("\nTesting on rra_list:\n")
test_result_rra <- where_is("Gene1", rra_list)
print(test_result_rra)
# List RDS files in the working directory
rds_files <- list.files(".", pattern = "\\.RDS$|\\.rds$", full.names = TRUE)
cat("RDS files in working directory:\n")
print(rds_files)
# Check file modification times
if(length(rds_files) > 0) {
file_info <- file.info(rds_files)
file_info$name <- rownames(file_info)
file_info <- file_info[order(file_info$mtime, decreasing = TRUE), ]
cat("\n\nMost recent RDS files:\n")
print(file_info[, c("name", "size", "mtime")])
}
# List RDS files in the working directory
rds_files <- list.files(".", pattern = "\\.RDS$|\\.rds$", full.names = TRUE)
cat("RDS files in working directory:\n")
for(f in rds_files) {
cat(f, "-", file.info(f)$size, "bytes -",
format(file.info(f)$mtime, "%Y-%m-%d %H:%M:%S"), "\n")
}
# Load the RDS files
mle_graphlist <- readRDS("./mle_graphlist.RDS")
rra_graphlist <- readRDS("./rra_graphlist.RDS")
cat("=== MLE Graph List Structure ===\n")
cat("Class:", class(mle_graphlist), "\n")
cat("Length:", length(mle_graphlist), "\n")
cat("Names:", paste(head(names(mle_graphlist), 10), collapse=", "), "\n")
if(length(mle_graphlist) > 10) cat("... and", length(mle_graphlist) - 10, "more\n")
cat("\nFirst element:\n")
cat("  Class:", class(mle_graphlist[[1]]), "\n")
cat("  Is gg?", inherits(mle_graphlist[[1]], "gg"), "\n")
if(inherits(mle_graphlist[[1]], "gg")) {
cat("  Data columns:", paste(names(mle_graphlist[[1]]$data), collapse=", "), "\n")
cat("  Has 'square' column?", "square" %in% names(mle_graphlist[[1]]$data), "\n")
cat("  Has 'id' column?", "id" %in% names(mle_graphlist[[1]]$data), "\n")
cat("  First few rows of id column:\n")
print(head(mle_graphlist[[1]]$data$id, 5))
}
cat("\n\n=== RRA Graph List Structure ===\n")
cat("Class:", class(rra_graphlist), "\n")
cat("Length:", length(rra_graphlist), "\n")
cat("Names:", paste(head(names(rra_graphlist), 10), collapse=", "), "\n")
if(length(rra_graphlist) > 10) cat("... and", length(rra_graphlist) - 10, "more\n")
cat("\nFirst element:\n")
cat("  Class:", class(rra_graphlist[[1]]), "\n")
cat("  Is gg?", inherits(rra_graphlist[[1]], "gg"), "\n")
if(inherits(rra_graphlist[[1]], "gg")) {
cat("  Data columns:", paste(names(rra_graphlist[[1]]$data), collapse=", "), "\n")
cat("  Has 'square' column?", "square" %in% names(rra_graphlist[[1]]$data), "\n")
cat("  Has 'id' column?", "id" %in% names(rra_graphlist[[1]]$data), "\n")
cat("  First few rows of id column:\n")
print(head(rra_graphlist[[1]]$data$id, 5))
}
# Test where_is on the actual data
cat("=== Testing where_is on MLE graph list ===\n")
test_genes <- c("Ms4a6c", "Irf1", "Nfkb2")
cat("Testing with test genes:", paste(test_genes, collapse=", "), "\n\n")
mle_result <- where_is(test_genes, mle_graphlist)
cat("MLE result:\n")
print(str(mle_result))
cat("\n\n=== Testing where_is on RRA graph list ===\n")
rra_result <- where_is(test_genes, rra_graphlist)
cat("RRA result:\n")
print(str(rra_result))
cat("\n\n=== Checking if results are correct ===\n")
cat("MLE result class:", class(mle_result), "\n")
cat("RRA result class:", class(rra_result), "\n")
if(is.list(mle_result)) {
cat("\nMLE first comparison (", names(mle_result)[1], "):\n", sep="")
print(mle_result[[1]])
}
if(is.list(rra_result)) {
cat("\nRRA first comparison (", names(rra_result)[1], "):\n", sep="")
print(rra_result[[1]])
}
# Check if the test genes exist in all graphs
cat("=== Checking gene presence in each graph ===\n\n")
for(i in seq_along(mle_graphlist)) {
graph_name <- names(mle_graphlist)[i]
cat("MLE Graph:", graph_name, "\n")
for(gene in test_genes) {
present <- gene %in% mle_graphlist[[i]]$data$id
cat("  ", gene, ":", present, "\n")
}
cat("\n")
}
cat("\n=== Testing on a single problematic graph ===\n")
cat("Testing on byrep_UT_ASTsen_r1:\n")
prob_graph <- mle_graphlist[["byrep_UT_ASTsen_r1"]]
cat("\nDoes Ms4a6c exist in this graph?", "Ms4a6c" %in% prob_graph$data$id, "\n")
cat("Does Nfkb2 exist in this graph?", "Nfkb2" %in% prob_graph$data$id, "\n")
# Try where_is on single graph
cat("\nTrying where_is on single graph:\n")
single_result <- where_is("Nfkb2", prob_graph)
print(single_result)
cat("\nTrying where_is with a gene that doesn't exist:\n")
missing_result <- where_is("Ms4a6c", prob_graph)
print(missing_result)
# Test if RRA has the same issue
cat("=== Testing RRA graph list ===\n")
# Try where_is on RRA list
cat("\nTesting where_is on RRA list (should work if all genes present):\n")
try({
rra_test_result <- where_is(test_genes, rra_graphlist)
print(str(rra_test_result))
}, silent = FALSE)
# Check if genes are present in all RRA graphs
cat("\n=== Checking gene presence in RRA graphs ===\n")
for(i in seq_along(rra_graphlist)) {
graph_name <- names(rra_graphlist)[i]
cat("\nRRA Graph:", graph_name, "\n")
all_present <- TRUE
for(gene in test_genes) {
present <- gene %in% rra_graphlist[[i]]$data$id
if(!present) all_present <- FALSE
cat("  ", gene, ":", present, "\n")
}
if(all_present) cat("  ✓ All genes present\n")
}
# Reload the package with the fix
library(devtools)
load_all("D:/Bibliotecas/Biologia/crispyr")
cat("=== Testing fixed where_is on MLE graph list ===\n")
mle_result_fixed <- where_is(test_genes, mle_graphlist)
print(mle_result_fixed)
cat("\n=== Testing on RRA graph list (should still work) ===\n")
rra_result_fixed <- where_is(test_genes, rra_graphlist)
print(rra_result_fixed)
cat("\n=== Testing with a mix of present and absent genes ===\n")
mixed_genes <- c("Ms4a6c", "NonExistentGene", "Irf1")
mle_mixed <- where_is(mixed_genes, mle_graphlist)
print(mle_mixed)
# Regenerate documentation
library(devtools)
document("D:/Bibliotecas/Biologia/crispyr")
# Reload and test the updated function with documentation
load_all("D:/Bibliotecas/Biologia/crispyr")
cat("=== Final verification test ===\n\n")
# Test 1: Single gene, single graph (gene present)
cat("Test 1: Single gene in single graph (present)\n")
result1 <- where_is("Ms4a6c", mle_graphlist[[1]])
print(result1)
# Test 2: Single gene, single graph (gene absent)
cat("\nTest 2: Single gene in single graph (absent)\n")
result2 <- where_is("Ms4a6c", mle_graphlist[[3]])
print(result2)
# Test 3: Multiple genes, single graph (some present)
cat("\nTest 3: Multiple genes in single graph\n")
result3 <- where_is(c("Ms4a6c", "NonExistent", "Irf1"), mle_graphlist[[1]])
print(result3)
# Test 4: Multiple genes, list of graphs
cat("\nTest 4: Multiple genes in list of graphs (MLE)\n")
result4 <- where_is(c("Ms4a6c", "Irf1"), mle_graphlist)
print(str(result4, max.level = 2))
cat("\n✓ All tests passed! Documentation updated.\n")
cat("\nSummary of behavior:\n")
cat("- Single gene not found: returns character(0)\n")
cat("- Multiple genes with some not found: returns NA for missing genes\n")
cat("- List of graphs: returns nested list with NA for genes not in specific graphs\n")
install()
document()
check()
# Run check() on the package
library(devtools)
check("D:/Bibliotecas/Biologia/crispyr")
# Check what arguments NSbasedf currently has
args(crispyr::NSbasedf)
library(devtools)
check("D:/Bibliotecas/Biologia/crispyr")
library(devtools)
check("D:/Bibliotecas/Biologia/crispyr")
devtools::test("D:/Bibliotecas/Biologia/crispyr")
# Check result of devtools::test() if it finished
# If we have results, this will show test summary
results <- devtools::test("D:/Bibliotecas/Biologia/crispyr", reporter = "summary")
results
# Run specific test files to check fixes
devtools::test("D:/Bibliotecas/Biologia/crispyr", filter = "NineSquares")
devtools::test("D:/Bibliotecas/Biologia/crispyr", reporter = "summary")
devtools::test("D:/Bibliotecas/Biologia/crispyr", filter = "NineSquares_helpers")
devtools::test("D:/Bibliotecas/Biologia/crispyr", filter = "NineSquares_helpers")
devtools::test("D:/Bibliotecas/Biologia/crispyr", reporter = "progress")
# Run the existing tests to see current state
devtools::test()
# Run just the ImportDrugZ tests to see what warnings are occurring
testthat::test_file("tests/testthat/test-ImportDrugZ.R")
# Check if there's a test file for CountIndex
list.files("tests/testthat", pattern = "CountIndex")
# Run the new CountIndex tests
testthat::test_file("tests/testthat/test-CountIndex.R")
# Check withr::with_locale signature
?withr::with_locale
# Check the function signature
args(withr::with_locale)
# Check documentation example
# The 'new' argument should be a named character vector
withr::with_locale(c(LC_COLLATE = "C"), sort(c("b", "A", "a")))
# Reload and test
devtools::load_all()
testthat::test_file("tests/testthat/test-CountIndex.R")
devtools::load_all()
devtools::load_all(quiet = TRUE)
# Use gert package which integrates with RStudio's git config
gert::git_commit("Add tests for CountIndex, fix withr::with_locale bug, fix tidyselect deprecation warnings
- Add test-CountIndex.R with tests for calculate_totals() and CountIndex()
- Fix CountIndex(): use named vector c(LC_COLLATE=...) instead of keyword arg
- Fix tidyselect deprecation: replace .data$col with \"col\" in select()/relocate()
in ImportDrugZ.R and ImportRRA.R
- Add comprehensive test suites for Import*, NineSquares*, Postprocess_utils
All 227 tests pass, R CMD check: 0 errors, 0 warnings")
gert::git_push()
install()
